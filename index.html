<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Weltnachrichten ‚Äì KI-Zusammenfassung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { margin:0; font-family:system-ui, Arial; background:#0b1220; color:#e5e7eb; }
header { position:sticky; top:0; background:#0f172a; padding:16px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,.4); z-index:10; }
header h1 { margin:0; font-size:20px; }
.categories { display:flex; gap:10px; overflow-x:auto; padding:12px; }
.cat { padding:8px 14px; border-radius:999px; background:#1e293b; font-size:13px; cursor:pointer; white-space:nowrap; }
.cat.active { background:#38bdf8; color:#020617; font-weight:bold; }
main { padding:16px; max-width:900px; margin:auto; }
.topic { background:#111827; border-radius:16px; padding:16px; margin-bottom:20px; box-shadow:0 10px 25px rgba(0,0,0,.4); }
.topic h2 { margin:0 0 6px; font-size:16px; color:#f9fafb; }
.topic p { font-size:14px; line-height:1.6; color:#d1d5db; }
.ki-summary { background:#1e40af; color:#f0fdf4; padding:12px; border-radius:12px; margin-top:8px; font-size:14px; line-height:1.5; }
.sources { margin-top:12px; font-size:12px; }
.sources a { color:#38bdf8; text-decoration:none; display:block; margin-bottom:2px; }
.date { font-size:12px; color:#9ca3af; margin-bottom:4px; }
</style>
</head>
<body>
<header>
  <h1>üåç Weltnachrichten ‚Äì Zusammenfassung</h1>
  <div class="categories" id="categories"></div>
</header>
<main id="news"></main>
<script>
// RSS-Feeds pro Kategorie
const feeds = {
  "Alle": [
    "https://feeds.bbci.co.uk/news/rss.xml",
    "https://www.reuters.com/rssFeed/world",
    "https://www.dw.com/zh/top-stories/s-9097?format=rss",
    "https://apnews.com/apf-topnews/rss",
    "https://www.ft.com/?format=rss",
    "https://www.bloomberg.com/feed/podcast",
    "https://www.theguardian.com/world/rss",
    "https://www.vox.com/rss/index.xml",
    "https://www.huffpost.com/section/world-news/feed"
  ],
  "Politik": [
    "https://feeds.bbci.co.uk/news/politics/rss.xml",
    "https://www.theguardian.com/politics/rss",
    "https://www.vox.com/policy-and-politics/rss/index.xml",
    "https://www.huffpost.com/section/politics/feed"
  ],
  "Wirtschaft": [
    "https://www.ft.com/?format=rss",
    "https://www.bloomberg.com/feed/podcast",
    "https://www.reuters.com/rssFeed/business",
    "https://apnews.com/apf-business/rss"
  ],
  "Technologie": [
    "https://www.theguardian.com/technology/rss",
    "https://www.vox.com/technology/rss/index.xml",
    "https://www.huffpost.com/section/technology/feed"
  ],
  "Klima": [
    "https://www.theguardian.com/environment/rss",
    "https://www.vox.com/energy-and-environment/rss/index.xml",
    "https://www.commondreams.org/rss/environment"
  ]
};

const newsEl = document.getElementById("news");
const catEl = document.getElementById("categories");

// Kategorien-Buttons hart codiert
const categoryNames = Object.keys(feeds);
categoryNames.forEach((cat, i) => {
  const btn = document.createElement("div");
  btn.className = "cat" + (i===0 ? " active" : "");
  btn.textContent = cat;
  btn.onclick = () => {
    document.querySelectorAll('.cat').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    loadNews(cat);
  };
  catEl.appendChild(btn);
});

// Hilfsfunktionen
function normalizeTitle(title){
  return title.toLowerCase().replace(/[^a-z0-9 ]/gi,'').split(' ').slice(0,6).join(' ');
}

function mergeSummaries(texts){
  const joined = texts.join(' ');
  let result = joined.split('. ').slice(0,6).join('. ') + '.';
  if(result.length < 200) result = joined.slice(0,200) + '‚Ä¶';
  if(result.length > 300) result = result.slice(0,300) + '‚Ä¶';
  return result;
}

async function translate(text){
  try{
    const res = await fetch("https://libretranslate.de/translate", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({q:text, source:"auto", target:"de"})
    });
    const data = await res.json();
    return data.translatedText || text;
  }catch(e){
    console.log("√úbersetzung fehlgeschlagen", e);
    return text;
  }
}

async function generateKISummary(texts){
  const merged = texts.join(' ');
  const sentences = merged.split('. ').filter(s => s.length>40).slice(0,6).join('. ');
  return await translate(sentences.length ? sentences : merged.slice(0,250)+'‚Ä¶');
}

async function loadNews(category="Alle"){
  newsEl.innerHTML="";
  const topics = {};
  const today = new Date().toDateString();

  for(const feed of feeds[category]){
    try{
      const res = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(feed));
      const xml = new DOMParser().parseFromString(await res.text(),"text/xml");
      const items = Array.from(xml.querySelectorAll("item")).slice(0,8);

      for(const item of items){
        const titleRaw = item.querySelector("title")?.textContent || "";
        const descRaw = item.querySelector("description")?.textContent?.replace(/<[^>]+>/g,'') || "";
        const link = item.querySelector("link")?.textContent || "";
        const pubDateRaw = item.querySelector("pubDate")?.textContent || "";
        const pubDate = pubDateRaw ? new Date(pubDateRaw) : null;

        if(!pubDate || pubDate.toDateString() !== today) continue; // nur heute

        const key = normalizeTitle(titleRaw);
        if(!topics[key]) topics[key] = {titles:[], texts:[], links:[], dates:[]};
        topics[key].titles.push(titleRaw);
        topics[key].texts.push(descRaw);
        topics[key].links.push(link);
        topics[key].dates.push(pubDateRaw);
      }
    }catch(e){
      console.log("Feed Fehler:", feed, e);
    }
  }

  for(const key in topics){
    const topic = topics[key];
    const titleTranslated = await translate(topic.titles[0]);
    const summaryTranslated = await translate(mergeSummaries(topic.texts));
    const date = topic.dates[0] ? new Date(topic.dates[0]).toLocaleDateString('de-DE') : "";

    const div = document.createElement("div");
    div.className = "topic";

    // KI-Zusammenfassung nur, wenn mehrere Quellen
    let kiHtml = '';
    if(topic.links.length > 1){
      const kiSummary = await generateKISummary(topic.texts);
      kiHtml = `<div class="ki-summary">KI-Zusammenfassung: ${kiSummary}</div>`;
    }

    div.innerHTML = `
      <div class="date">${date}</div>
      <h2>${titleTranslated}</h2>
      <p>${summaryTranslated}</p>
      ${kiHtml}
      <div class="sources">
        Quellen:
        ${topic.links.map(l => `<a href="${l}" target="_blank">${l}</a>`).join('')}
      </div>
    `;
    newsEl.appendChild(div);
  }
}

// Initial laden + Auto-Refresh alle 5 Minuten
loadNews();
setInterval(() => loadNews(document.querySelector('.cat.active')?.textContent || 'Alle'), 5*60*1000);
</script>
</body>
</html>
