<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Weltnachrichten ‚Äì Optimiert</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { margin:0; font-family:system-ui, Arial; background:#0b1220; color:#e5e7eb; }
header { position:sticky; top:0; background:#0f172a; padding:16px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,.4); z-index:10; }
header h1 { margin:0; font-size:20px; }
.categories { display:flex; gap:10px; overflow-x:auto; padding:12px; }
.cat { padding:8px 14px; border-radius:999px; background:#1e293b; font-size:13px; cursor:pointer; white-space:nowrap; }
.cat.active { background:#38bdf8; color:#020617; font-weight:bold; }
main { padding:16px; max-width:900px; margin:auto; }
.topic { background:#111827; border-radius:16px; padding:16px; margin-bottom:20px; box-shadow:0 10px 25px rgba(0,0,0,.4); }
.topic h2 { margin:0 0 6px; font-size:16px; color:#f9fafb; }
.topic p { font-size:14px; line-height:1.6; color:#d1d5db; }
.ki-summary { background:#1e40af; color:#f0fdf4; padding:12px; border-radius:12px; margin-top:8px; font-size:14px; line-height:1.5; }
.summary-all { background:#047857; color:#f0fdf4; padding:14px; border-radius:12px; margin-top:12px; font-size:15px; line-height:1.5; white-space:pre-line; }
.sources { margin-top:12px; font-size:12px; }
.sources a { color:#38bdf8; text-decoration:none; display:block; margin-bottom:2px; }
.date { font-size:12px; color:#9ca3af; margin-bottom:4px; }
</style>
</head>
<body>
<header>
  <h1>üåç Weltnachrichten ‚Äì Optimiert</h1>
  <div class="categories" id="categories"></div>
</header>
<main id="news"><p>L√§dt Inhalte‚Ä¶</p></main>
<script>
// RSS-Feeds pro Kategorie (max. Artikel pro Feed reduziert)
const feeds = {
  "Alle": [
    "https://feeds.bbci.co.uk/news/rss.xml",
    "https://www.reuters.com/rssFeed/world",
    "https://apnews.com/apf-topnews/rss",
    "https://www.spiegel.de/schlagzeilen/tops/index.rss",
    "https://www.sueddeutsche.de/news/rss/uebersicht",
    "https://www.faz.net/rss/aktuell/"
  ],
  "Politik": [
    "https://feeds.bbci.co.uk/news/politics/rss.xml",
    "https://www.theguardian.com/politics/rss",
    "https://www.spiegel.de/politik/index.rss"
  ],
  "Wirtschaft": [
    "https://www.ft.com/?format=rss",
    "https://www.bloomberg.com/feed/podcast",
    "https://www.spiegel.de/wirtschaft/index.rss"
  ],
  "Technologie": [
    "https://www.theguardian.com/technology/rss",
    "https://www.spiegel.de/netzwelt/index.rss"
  ],
  "Klima": [
    "https://www.theguardian.com/environment/rss",
    "https://www.spiegel.de/wissenschaft/umwelt/index.rss"
  ]
};

const newsEl = document.getElementById("news");
const catEl = document.getElementById("categories");
const categoryNames = [...Object.keys(feeds), "Tageszusammenfassung"];
const todayStr = new Date().toDateString();
const localCacheKey = "translatedSummaries";

categoryNames.forEach((cat,i)=>{
  const btn = document.createElement("div");
  btn.className="cat"+(i===0?" active":"");
  btn.textContent=cat;
  btn.onclick = ()=>{
    document.querySelectorAll('.cat').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    cat==="Tageszusammenfassung"?loadSummaryAll():loadNews(cat);
  };
  catEl.appendChild(btn);
});

// Hilfsfunktionen
function normalizeTitle(title){return title.toLowerCase().replace(/[^a-z0-9 ]/gi,'').split(' ').slice(0,6).join(' ');}
function mergeSummaries(texts){return texts.join('. ').slice(0,300)+'‚Ä¶';}
async function translate(text){
  try{
    const cached = JSON.parse(localStorage.getItem(localCacheKey)||"{}");
    if(cached[text]) return cached[text];
    const res = await fetch("https://libretranslate.de/translate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({q:text,source:"auto",target:"de"})});
    const data = await res.json();
    cached[text]=data.translatedText||text;
    localStorage.setItem(localCacheKey,JSON.stringify(cached));
    return cached[text];
  }catch(e){console.log("√úbersetzung fehlgeschlagen",e); return text;}
}
async function generateKISummary(texts,maxLen=4000){let merged=texts.join('. ');let trimmed=merged.slice(0,maxLen);return await translate(trimmed);}

// Lade Nachrichten
async function loadNews(category="Alle"){
  newsEl.innerHTML="<p>L√§dt Nachrichten‚Ä¶</p>";
  const topics={};
  for(const feed of feeds[category]){
    try{
      const res = await fetch("https://api.allorigins.win/raw?url="+encodeURIComponent(feed));
      const xml = new DOMParser().parseFromString(await res.text(),"text/xml");
      const items = Array.from(xml.querySelectorAll("item")).slice(0,5);
      for(const item of items){
        const pubDateRaw=item.querySelector("pubDate")?.textContent;
        const pubDate = pubDateRaw?new Date(pubDateRaw):null;
        if(!pubDate || pubDate.toDateString()!==todayStr) continue;
        const title=item.querySelector("title")?.textContent||"";
        const desc=item.querySelector("description")?.textContent?.replace(/<[^>]+>/g,'')||"";
        const link=item.querySelector("link")?.textContent||"";
        const key=normalizeTitle(title);
        if(!topics[key]) topics[key]={titles:[],texts:[],links:[],dates:[]};
        topics[key].titles.push(title); topics[key].texts.push(desc); topics[key].links.push(link); topics[key].dates.push(pubDateRaw);
      }
    }catch(e){console.log("Feed Fehler:",feed,e);}
  }

  newsEl.innerHTML="";
  for(const key in topics){
    const t = topics[key];
    const titleTranslated = await translate(t.titles[0]);
    const summaryTranslated = await translate(mergeSummaries(t.texts));
    const date = t.dates[0]?new Date(t.dates[0]).toLocaleDateString('de-DE'):"";
    const div=document.createElement("div"); div.className="topic";
    let kiHtml="";
    if(t.links.length>1){const kiSummary=await generateKISummary(t.texts,300); kiHtml=`<div class="ki-summary">KI-Zusammenfassung: ${kiSummary}</div>`;}
    div.innerHTML=`<div class="date">${date}</div><h2>${titleTranslated}</h2><p>${summaryTranslated}</p>${kiHtml}<div class="sources">Quellen:${t.links.map(l=>`<a href="${l}" target="_blank">${l}</a>`).join('')}</div>`;
    newsEl.appendChild(div);
  }
}

// Tageszusammenfassung
async function loadSummaryAll(){
  newsEl.innerHTML="<p>L√§dt Tageszusammenfassung‚Ä¶</p>";
  let categoryTexts={};
  for(const category in feeds){
    categoryTexts[category]=[];
    for(const feed of feeds[category]){
      try{
        const res = await fetch("https://api.allorigins.win/raw?url="+encodeURIComponent(feed));
        const xml = new DOMParser().parseFromString(await res.text(),"text/xml");
        const items=Array.from(xml.querySelectorAll("item")).slice(0,5);
        for(const item of items){
          const pubDateRaw=item.querySelector("pubDate")?.textContent;
          const pubDate = pubDateRaw?new Date(pubDateRaw):null;
          if(!pubDate || pubDate.toDateString()!==todayStr) continue;
          const desc=item.querySelector("description")?.textContent?.replace(/<[^>]+>/g,'')||"";
          categoryTexts[category].push(desc);
        }
      }catch(e){console.log("Feed Fehler:",feed,e);}
    }
  }

  let finalText="";
  for(const cat in categoryTexts){
    if(categoryTexts[cat].length>0){
      finalText+=`== ${cat} ==\n`;
      const mergedText = categoryTexts[cat].slice(0,50).join('. ');
      const summaryCat = await generateKISummary([mergedText],1000);
      finalText+=summaryCat+'\n\n';
    }
  }
  if(finalText.length>4000) finalText=finalText.slice(0,4000)+'‚Ä¶';
  newsEl.innerHTML=`<div class="summary-all">${finalText}</div>`;
}

// Initial laden + Auto-Refresh
loadNews();
setInterval(()=>loadNews(document.querySelector('.cat.active')?.textContent||'Alle'),5*60*1000);
setInterval(()=>{if(document.querySelector('.cat.active')?.textContent==="Tageszusammenfassung"){loadSummaryAll();}},12*60*60*1000);
</script>
</body>
</html>
